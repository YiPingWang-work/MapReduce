# MapReduce基础实现







### 注意	

​	本版本未实现网络通讯功能和实际的计算框架，只是对相互通讯协议作出设计。



### 核心逻辑

​	map reduce将节点分成两部分，master节点和slave节点。master节点负责创建作业（work），划分任务（work -> tasks），分发任务（tasks -> slave）；slave节点负责执行任务。

​	任务被划分成两种，map任务和reduce任务，其中map任务的执行的同步的，立即的，也就是slave节点收到后立即执行，执行后将结果返回给master。reduce任务执行的异步的，等待的，本文实现的mapreduce框架并不是等待所有的map任务执行完才去执行reduce任务，二者是可以并发执行的，master收到一个map任务的回复后，会将其告诉所有执行本workreduce任务的slave，这些slave一旦收到一个map任务，则会执行，一直到收到所有的map的执行结果，最后返回。

​	具体的：

#### Master逻辑：

​	master收到客户端的一个work后，会将其划分成m个map任务，n个reduce任务，其中m, n是通过初始处理块和Hash函数的输出种类得到的。之后master将这m + n个任务分配给slave节点，标记任务为executing态，如果派发的是Map任务，则启动一个任务定时器。定时器到期后认为任务无法被slave完成，不再接收这个slave关于这个task的响应，并将这个task重新派发给一个空闲的slave。如果是一个reduce任务且此时该work的所有map任务还没有完成，不做处理，如果所有的map任务已经完成了，同样启动一个任务定时器，和map任务做相同处理。

​	如果收到一个合法的map完成提示，则会增加完成map的数量（master会将结果地址保存在内存中），并通知所有执行该work reduce任务的slave该map任务的结果位置。如果发现这个work的所有map任务都执行完成，则会为所有执行该work reduce任务添加一个任务计时器。

​	对于每次任务的执行，master为其分配一个唯一递增的编号，如果收到任务的回复和当前这个任务的编号一致，那么master就认为这是一个成功执行的任务；若小于master记录的编号，则任务master已经主观放弃了此次分配，slave执行的结果将不具有意义，master将其分配给了其他slave，master不会做任何处理；如果编号大，Panic，这种情况异常。

​	关于定时器：每个分配的任务（任务的执行）会唯一拥有一个定时器，当定时器到期，master会首先检查网络问题，有三次的重传验证，如果网络没有问题，slave也正常响应，则可能是slave执行较慢，master会再次等待一段时间，再次检查网络，如果重试三次网络都是失败或者slave不响应。master才会觉得slave宕机，将该次任务的执行作废；如果slave三次正确响应但是还不回复结果，master认为这个slave不具备复杂运算的能力，即使它没有宕机，此时也会将该次任务的执行作废。

​	关于reduce的两个阶段：reduce在map未完成前不需要定时器，在所有map执行结束后才会设置定时器。

​	

#### Slave逻辑：

​	slave有两个线程，一个负责时刻回复客户端的响应，一个负责处理事件，slave会暂存上一个执行完的任务直到新任务到来。一旦收到master的响应指令，立即回送一个响应返回，证明自己还活着。slave只会接受编号大于等于自己执行任务的任务。

​	如果此时slave空闲但到来一个任务是自己暂存的上一个执行完的任务，slave将立即返回暂存的任务结果。

​	如果此时slave处于Reduce阶段但是收到了一个比自己阻塞等待Reduce阶段更大的编号的任务，则放弃此次任务，执行新任务。

​	如果此时slave处于Reduce阶段但是收到了和自己阻塞等待Reduce阶段一致编号的任务，则比较两次任务Map任务的异同，执行缺失的Map任务结果的reduce任务，如果发现所有的map结果的reduce都已经执行完成，返回Reduce执行完成。

​	当一个任务成功执行完成的话，都重写暂存任务，同时将当前任务设置为空。



#### 任务数据和结果数据

​	slave将使用 ``slave_id$task_id$[...]``存储在可靠的远端数据库。slave和master之间的数据传输不会传输数据，而是传输这些数据在数据库中的位置信息。





### 开发文件说明

```
Kernel/Logic 中存储的是核心代码逻辑
	  /Message 中存储的是上下交互逻辑
	  /Logic/logic_test.go 因为没有底层网络，暂时使用channel测试代码逻辑功能
```

